


<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel - Musk & Amber</title>
    <!-- Favicon -->
    <link rel="icon" type="image/x-icon" href="./logo.jpeg">
    <link rel="shortcut icon" type="image/x-icon" href="./logo.jpeg">
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary-color: #561e4b;
            --primary-dark: #868d7d;
            --danger-color: #f44336;
            --danger-dark: #d32f2f;
            --warning-color: #ff9800;
            --info-color: #7c5772;
            --light-gray: #443b44;
            --medium-gray: #b882aa;
            --dark-gray: #333;
        }
        
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            margin: 0; 
            background-color: var(--light-gray);
            color: #333;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background-color: white;
            min-height: 100vh;
            box-shadow: 0 0 20px rgba(0,0,0,0.1);
        }
        
        header {
            background-color: rgb(255, 255, 255);
            padding: 15px 20px;
            border-bottom: 1px solid var(--medium-gray);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .logo {
            font-size: 24px;
            font-weight: bold;
            color: var(--primary-color);
        }
        
        .user-info {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .auth-section {
            padding: 40px 20px;
            max-width: 400px;
            margin: 0 auto;
        }
        
        .auth-form {
            background-color: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        
        h1 {
            color: var(--dark-gray);
            text-align: center;
            margin-bottom: 30px;
        }
        
        h2 {
            color: #444;
            margin-top: 30px;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--medium-gray);
        }
        
        .section {
            background-color: #f9f9f9;
            padding: 20px;
            margin-bottom: 20px;
            border-radius: 5px;
            border-left: 4px solid var(--primary-color);
        }
        
        input, button, textarea, select { 
            margin: 5px 0; 
            padding: 10px; 
            width: 100%; 
            box-sizing: border-box;
            border: 1px solid var(--medium-gray);
            border-radius: 4px;
            font-family: inherit;
        }
        
        button {
            background-color: var(--primary-color);
            color: white;
            border: none;
            cursor: pointer;
            transition: background-color 0.3s;
            font-weight: 600;
        }
        
        button:hover {
            background-color: var(--primary-dark);
        }
        
        .delete-btn {
            background-color: var(--danger-color);
        }
        
        .delete-btn:hover {
            background-color: var(--danger-dark);
        }
        
        .secondary-btn {
            background-color: var(--medium-gray);
            color: var(--dark-gray);
        }
        
        .secondary-btn:hover {
            background-color: #d0d0d0;
        }
        
        .upload-btn {
            background-color: var(--info-color);
        }
        
        .upload-btn:hover {
            background-color: #1976D2;
        }
        
        #debug { 
            border: 1px solid #ccc; 
            padding: 10px; 
            max-height: 200px; 
            overflow-y: scroll; 
            background-color: #f9f9f9;
            font-family: monospace;
            font-size: 12px;
            border-radius: 4px;
        }
        
        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
            background-color: white;
            border-radius: 4px;
            overflow: hidden;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        
        .data-table th, .data-table td {
            border: 1px solid var(--medium-gray);
            padding: 12px;
            text-align: left;
        }
        
        .data-table th {
            background-color: #f2f2f2;
            font-weight: 600;
        }
        
        .data-table tr:nth-child(even) {
            background-color: #f9f9f9;
        }
        
        .data-table tr:hover {
            background-color: #f1f1f1;
        }
        
        .tab-container {
            margin-top: 20px;
        }
        
        .tab-buttons {
            display: flex;
            border-bottom: 1px solid var(--medium-gray);
            background-color: rgb(255, 255, 255);
            flex-wrap: wrap;
        }
        
        .tab-button {
            padding: 12px 24px;
            background-color: #1a0606;
            border: none;
            border-bottom: 2px solid transparent;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 500;
            white-space: nowrap;
        }
        
        .tab-button.active {
            background-color: white;
            border-bottom: 2px solid var(--primary-color);
            font-weight: bold;
            color: var(--primary-color);
        }
        
        .tab-content {
            display: none;
            padding: 20px;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .product-image {
            max-width: 100px;
            max-height: 100px;
            object-fit: cover;
            border-radius: 4px;
        }
        
        .status-select {
            width: auto;
            padding: 6px;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
        }
        
        .image-preview {
            max-width: 200px;
            max-height: 200px;
            margin-top: 10px;
            border-radius: 4px;
            display: none;
        }
        
        .uploaded-image {
            max-width: 200px;
            max-height: 200px;
            object-fit: cover;
            border-radius: 4px;
            margin-top: 10px;
        }
        
        .upload-status {
            margin: 10px 0;
            padding: 10px;
            border-radius: 4px;
            display: none;
        }
        
        .upload-success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .upload-error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .upload-progress {
            background-color: #e3f2fd;
            color: #1565c0;
            border: 1px solid #bbdefb;
        }
        
        .stats-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .stat-card {
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            text-align: center;
        }
        
        .stat-value {
            font-size: 28px;
            font-weight: bold;
            margin: 10px 0;
        }
        
        .stat-label {
            color: #666;
            font-size: 14px;
        }
        
        .alert {
            padding: 12px;
            border-radius: 4px;
            margin-bottom: 15px;
        }
        
        .alert-success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .alert-error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .hidden {
            display: none;
        }
        
        .loading {
            text-align: center;
            padding: 20px;
        }
        
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-left-color: var(--primary-color);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .login-message {
            text-align: center;
            margin-top: 20px;
            color: #666;
        }
        
        .file-input-wrapper {
            position: relative;
            overflow: hidden;
            display: inline-block;
            width: 100%;
        }
        
        .file-input-wrapper input[type=file] {
            position: absolute;
            left: 0;
            top: 0;
            opacity: 0;
            width: 100%;
            height: 100%;
            cursor: pointer;
        }

        /* Checkbox Styles */
        .checkbox-group {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-top: 10px;
        }
        
        .checkbox-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .checkbox-item input[type="checkbox"] {
            width: auto;
            margin: 0;
        }
        
        .checkbox-item label {
            margin: 0;
            font-weight: normal;
        }

        /* Message Styles */
        .message-container {
            background: white;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            border-left: 4px solid var(--primary-color);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .message-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 10px;
        }
        
        .message-sender {
            font-weight: bold;
            color: var(--dark-gray);
        }
        
        .message-email {
            color: var(--info-color);
            font-size: 14px;
        }
        
        .message-date {
            color: var(--medium-gray);
            font-size: 12px;
        }
        
        .message-content {
            margin: 10px 0;
            line-height: 1.5;
        }
        
        .message-actions {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }
        
        .message-status {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: bold;
            text-transform: uppercase;
        }
        
        .status-pending {
            background-color: var(--warning-color);
            color: white;
        }
        
        .status-read {
            background-color: var(--primary-color);
            color: white;
        }
        
        /* Order Details Styles */
        .order-details {
            background: white;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            border-left: 4px solid var(--info-color);
        }
        
        .order-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 15px;
        }
        
        .order-id {
            font-weight: bold;
            color: var(--dark-gray);
        }
        
        .order-total {
            font-size: 18px;
            font-weight: bold;
            color: var(--primary-color);
        }
        
        .order-items {
            margin: 15px 0;
        }
        
        .order-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #eee;
        }
        
        .order-item:last-child {
            border-bottom: none;
        }
        
        .item-name {
            flex: 2;
        }
        
        .item-size {
            flex: 1;
            text-align: center;
        }
        
        .item-price {
            flex: 1;
            text-align: right;
        }
        
        .order-customer {
            background: #f9f9f9;
            padding: 10px;
            border-radius: 4px;
            margin-top: 15px;
        }

        /* Notification Styles */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 5px;
            color: white;
            z-index: 10000;
            display: flex;
            align-items: center;
            gap: 10px;
            max-width: 300px;
            animation: slideIn 0.3s ease;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }
        
        .notification-success { 
            background-color: var(--primary-color); 
        }
        
        .notification-error { 
            background-color: var(--danger-color); 
        }
        
        .notification-warning { 
            background-color: var(--warning-color); 
        }
        
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        /* Search and Filter Styles */
        .search-box {
            margin-bottom: 20px;
        }
        
        .filter-options {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }
        
        .filter-btn {
            padding: 8px 15px;
            background: #2c612a;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        
        .filter-btn.active {
            background: var(--primary-color);
            color: white;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .tab-buttons {
                overflow-x: auto;
            }
            
            .tab-button {
                padding: 10px 15px;
                font-size: 14px;
            }
            
            .data-table {
                display: block;
                overflow-x: auto;
            }
            
            .stats-container {
                grid-template-columns: repeat(2, 1fr);
            }
        }
        
        @media (max-width: 480px) {
            .stats-container {
                grid-template-columns: 1fr;
            }
            
            .message-actions, .order-actions {
                flex-direction: column;
            }
            
            .checkbox-group {
                flex-direction: column;
                gap: 5px;
            }
        }
        .edit-btn {
            background-color: var(--warning-color);
            color: white;
        }

        .edit-btn:hover {
            background-color: #f57c00;
        }
          .radio-group {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 5px;
        }
        
        .radio-item {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .radio-item input[type="radio"] {
            width: auto;
            margin: 0;
        }
        
        .radio-item label {
            margin: 0;
            font-weight: normal;
        }
        
        .images-preview {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 10px;
        }
        
        .image-preview-item {
            position: relative;
            width: 100px;
            height: 100px;
            border-radius: 4px;
            overflow: hidden;
            border: 2px solid #ddd;
        }
        
        .image-preview-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .remove-image-btn {
            position: absolute;
            top: 2px;
            right: 2px;
            background: rgba(255, 0, 0, 0.8);
            color: white;
            border: none;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            font-size: 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .file-input-wrapper-multiple {
            position: relative;
            overflow: hidden;
            display: inline-block;
            width: 100%;
            margin-top: 10px;
        }
        
        .file-input-wrapper-multiple input[type=file] {
            position: absolute;
            left: 0;
            top: 0;
            opacity: 0;
            width: 100%;
            height: 100%;
            cursor: pointer;
        }
        
        .multi-upload-btn {
            background-color: #7c5772;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 4px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            width: 100%;
            justify-content: center;
        }
        
        .multi-upload-btn:hover {
            background-color: #6a4a63;
        }
        
        .volume-radio-group {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            gap: 10px;
            margin-top: 5px;
        }
        
        .stock-radio-group {
            display: flex;
            gap: 15px;
            margin-top: 5px;
        }
                /* Enhanced Checkbox Styles */
        .checkbox-group {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 10px;
            margin-top: 10px;
            padding: 10px;
            background: #f9f9f9;
            border-radius: 4px;
            border: 1px solid #eee;
        }

        .checkbox-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 5px;
            border-radius: 4px;
            transition: background 0.3s;
        }

        .checkbox-item:hover {
            background: #f0f0f0;
        }

        .checkbox-item input[type="checkbox"] {
            width: 18px;
            height: 18px;
            margin: 0;
            cursor: pointer;
        }

        .checkbox-item label {
            margin: 0;
            font-weight: normal;
            cursor: pointer;
            flex: 1;
        }
        /* Stock Status Colors */
        .stock-en-stock { background-color: #4caf50; }
        .stock-rupture { background-color: #f44336; }
        .stock-promotion { background-color: #ff9800; }
        .stock-nouveaute { background-color: #9c27b0; }
        /* Add this to your existing CSS */
.order-id-small {
    font-size: 11px !important;
    color: #666 !important;
    font-family: monospace !important;
    background: #f5f5f5 !important;
    padding: 2px 6px !important;
    border-radius: 3px !important;
    margin-right: 5px !important;
}

.whatsapp-link {
    color: #25D366 !important;
    text-decoration: none !important;
    font-weight: bold !important;
    display: inline-flex !important;
    align-items: center !important;
    gap: 5px !important;
}

.whatsapp-link:hover {
    text-decoration: underline !important;
}

.download-btn {
    background-color: #34A853 !important;
    color: white !important;
    border: none !important;
    padding: 8px 16px !important;
    border-radius: 4px !important;
    cursor: pointer !important;
    display: inline-flex !important;
    align-items: center !important;
    gap: 8px !important;
    font-weight: 500 !important;
    margin-right: 10px !important;
}

.download-btn:hover {
    background-color: #2E8B57 !important;
}

.hide-email {
    display: none !important;
}

.email-toggle-btn {
    background-color: #7c5772 !important;
    color: white !important;
    border: none !important;
    padding: 5px 10px !important;
    border-radius: 4px !important;
    cursor: pointer !important;
    font-size: 12px !important;
    margin-left: 10px !important;
}

.email-toggle-btn:hover {
    background-color: #6a4a63 !important;
}

.export-section {
    background: white !important;
    padding: 15px !important;
    border-radius: 8px !important;
    margin-bottom: 20px !important;
    border-left: 4px solid #34A853 !important;
}

.export-options {
    display: flex !important;
    flex-wrap: wrap !important;
    gap: 10px !important;
    margin-top: 10px !important;
}

.google-sheets-status {
    margin-top: 10px !important;
    padding: 10px !important;
    border-radius: 4px !important;
    font-size: 13px !important;
}

.status-success {
    background-color: #d4edda !important;
    color: #155724 !important;
    border: 1px solid #c3e6cb !important;
}

.status-error {
    background-color: #f8d7da !important;
    color: #721c24 !important;
    border: 1px solid #f5c6cb !important;
}
/* These can be removed since we're not using email toggle anymore */
.hide-email {
    display: none !important;
}

.email-toggle-btn {
    background-color: #7c5772 !important;
    color: white !important;
    border: none !important;
    padding: 5px 10px !important;
    border-radius: 4px !important;
    cursor: pointer !important;
    font-size: 12px !important;
    margin-left: 10px !important;
}

.email-toggle-btn:hover {
    background-color: #6a4a63 !important;
}
/* Add to existing CSS */
.product-image-admin {
    border: 2px solid #f0f0f0;
    transition: transform 0.3s;
}

.product-image-admin:hover {
    transform: scale(1.05);
    border-color: var(--primary-color);
}

.no-export-note {
    background: #fff3cd;
    color: #856404;
    border: 1px solid #ffeaa7;
    padding: 8px 12px;
    border-radius: 4px;
    font-size: 12px;
    margin: 5px 0;
    display: inline-flex;
    align-items: center;
    gap: 6px;
}
    </style>
</head>
<body>
    <div class="container">
        <!-- Login Section -->
        <div id="authSection" class="auth-section">
            <div class="auth-form">
                <h1>Connexion Admin Musk & Amber</h1>
                <div id="authMessage" class="alert hidden"></div>
                <div class="form-group">
                    <label for="email">Email:</label>
                    <input type="email" id="email" placeholder="admin@musk&amber.com">
                </div>
                <div class="form-group">
                    <label for="password">Mot de passe:</label>
                    <input type="password" id="password" placeholder="Votre mot de passe">
                </div>
                <button onclick="login()">Se connecter</button>
                <div class="login-message">
                    <p>Première connexion? Utilisez le bouton ci-dessous pour créer un compte.</p>
                    <button class="secondary-btn" onclick="showRegister()">Créer un compte admin</button>
                </div>
            </div>
            
            <!-- Register Form -->
            <div id="registerForm" class="auth-form hidden">
                <h1>Créer un compte Admin</h1>
                <div class="form-group">
                    <label for="regEmail">Email:</label>
                    <input type="email" id="regEmail" placeholder="admin@musk&amber.com">
                </div>
                <div class="form-group">
                    <label for="regPassword">Mot de passe:</label>
                    <input type="password" id="regPassword" placeholder="Mot de passe sécurisé">
                </div>
                <div class="form-group">
                    <label for="regConfirmPassword">Confirmer le mot de passe:</label>
                    <input type="password" id="regConfirmPassword" placeholder="Confirmer le mot de passe">
                </div>
                <button onclick="register()">Créer le compte</button>
                <div class="login-message">
                    <button class="secondary-btn" onclick="showLogin()">Retour à la connexion</button>
                </div>
            </div>
        </div>
        
        <!-- Admin Panel -->
        <div id="adminPanel" class="hidden">
            <header>
                <div class="logo">Musk & Amber Admin</div>
                <div class="user-info">
                    <span id="userEmail"></span>
                    <button class="secondary-btn" onclick="openTab('profile')">Profil</button>
                    <button class="delete-btn" onclick="logout()">Déconnexion</button>
                </div>
            </header>
            
            <div class="tab-container">
                <div class="tab-buttons">
                    <button class="tab-button active" onclick="openTab('dashboard')">Tableau de bord</button>
                    <button class="tab-button" onclick="openTab('products')">Produits</button>
                    <button class="tab-button" onclick="openTab('orders')">Commandes</button>
                    <button class="tab-button" onclick="openTab('contactMessages')">Messages Contact</button>
                    <button class="tab-button" onclick="openTab('profile')">Profil</button>
                </div>
                
                <!-- Dashboard Tab -->
                <div id="dashboard" class="tab-content active">
                    <h1>Tableau de bord</h1>
                    
                    <div class="stats-container">
                        <div class="stat-card">
                            <div class="stat-label">Produits</div>
                            <div class="stat-value" id="productsCount">0</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">Commandes</div>
                            <div class="stat-value" id="ordersCount">0</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">Revenus (MAD)</div>
                            <div class="stat-value" id="revenueCount">0</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">Messages</div>
                            <div class="stat-value" id="messagesCount">0</div>
                        </div>
                    </div>
                    
                    <div class="section">
                        <h2>Dernières commandes</h2>
                        <div id="recentOrders"></div>
                    </div>
                    
                    <div class="section">
                        <h2>Derniers messages</h2>
                        <div id="recentMessages"></div>
                    </div>
                </div>
                
                <!-- Products Tab -->
                <div id="products" class="tab-content">
                    <h1>Gestion des produits</h1>
                    
                    <div class="section">
                        <h2>Ajouter un produit</h2>
                         <div class="form-group">
                            <label for="productBrand">Marque:</label>
                            <input type="text" id="productBrand" placeholder="Ex: Channel, Dior, Gucci...">
                        </div>
                        <div class="form-group">
                            <label for="productName">Nom du produit:</label>
                            <input type="text" id="productName" placeholder="Ex: Oud Royal">
                        </div>
                        <div class="form-group">
                            <label for="productPrice">Prix (MAD):</label>
                            <input type="number" id="productPrice" placeholder="600" step="0.01">
                        </div>
                        <div class="form-group">
                            <label>Catégories:</label>
                            <div class="checkbox-group">
                                <div class="checkbox-item">
                                    <input type="checkbox" id="cat-arabes" value="arabes">
                                    <label for="cat-arabes">Parfums Arabes</label>
                                </div>
                                <div class="checkbox-item">
                                    <input type="checkbox" id="cat-femme" value="femme">
                                    <label for="cat-femme">Parfums Femme</label>
                                </div>
                                <div class="checkbox-item">
                                    <input type="checkbox" id="cat-homme" value="homme">
                                    <label for="cat-homme">Parfums Homme</label>
                                </div>
                                <div class="checkbox-item">
                                    <input type="checkbox" id="cat-niche" value="niche">
                                    <label for="cat-niche">Parfums de niche</label>
                                </div>
                                <div class="checkbox-item">
                                    <input type="checkbox" id="cat-coffrets" value="coffrets">
                                    <label for="cat-coffrets">Coffrets</label>
                                </div>
                                <div class="checkbox-item">
                                    <input type="checkbox" id="cat-nouveautes" value="nouveautes">
                                    <label for="cat-nouveautes">Nouveautés</label>
                                </div>
                            </div>
                        </div>
                         <div class="form-group">
                            <label>Volume :</label>
                            <div class="volume-radio-group">
                                <div class="radio-item">
                                    <input type="radio" id="vol-10" name="volume" value="10">
                                    <label for="vol-10">10 ml</label>
                                </div>
                                <div class="radio-item">
                                    <input type="radio" id="vol-30" name="volume" value="30">
                                    <label for="vol-30">30 ml</label>
                                </div>
                                <div class="radio-item">
                                    <input type="radio" id="vol-50" name="volume" value="50">
                                    <label for="vol-50">50 ml</label>
                                </div>
                                <div class="radio-item">
                                    <input type="radio" id="vol-60" name="volume" value="60">
                                    <label for="vol-60">60 ml</label>
                                </div>
                                <div class="radio-item">
                                    <input type="radio" id="vol-75" name="volume" value="75">
                                    <label for="vol-75">75 ml</label>
                                </div>
                                <div class="radio-item">
                                    <input type="radio" id="vol-80" name="volume" value="80">
                                    <label for="vol-80">80 ml</label>
                                </div>
                                <div class="radio-item">
                                    <input type="radio" id="vol-90" name="volume" value="90">
                                    <label for="vol-90">90 ml</label>
                                </div>
                                <div class="radio-item">
                                    <input type="radio" id="vol-100" name="volume" value="100">
                                    <label for="vol-100">100 ml</label>
                                </div>
                                <div class="radio-item">
                                    <input type="radio" id="vol-150" name="volume" value="150">
                                    <label for="vol-150">150 ml</label>
                                </div>
                                <div class="radio-item">
                                    <input type="radio" id="vol-200" name="volume" value="200">
                                    <label for="vol-200">200 ml</label>
                                </div>
                            </div>
                        </div>
                        <div class="form-group">
                            <label>Statut du stock (choix multiples):</label>
                            <div class="checkbox-group">
                                <div class="checkbox-item">
                                    <input type="checkbox" id="stock-in" name="stockStatus" value="en stock">
                                    <label for="stock-in">En stock</label>
                                </div>
                                <div class="checkbox-item">
                                    <input type="checkbox" id="stock-out" name="stockStatus" value="rupture de stock">
                                    <label for="stock-out">Rupture de stock</label>
                                </div>
                                <div class="checkbox-item">
                                    <input type="checkbox" id="stock-promo" name="stockStatus" value="promotion">
                                    <label for="stock-promo">Promotion</label>
                                </div>
                                <div class="checkbox-item">
                                    <input type="checkbox" id="stock-new" name="stockStatus" value="nouveauté">
                                    <label for="stock-new">Nouveauté</label>
                                </div>
                              
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="productDescription">Description:</label>
                            <textarea id="productDescription" placeholder="Description du produit..." rows="4"></textarea>
                        </div>
                        <div class="form-group">
                            <label>Images du produit:</label>
                            <div class="file-input-wrapper-multiple">
                                <button type="button" class="multi-upload-btn">
                                    <i class="fas fa-images"></i> Choisir plusieurs images (max 5)
                                </button>
                                <input type="file" id="multipleImageInput" accept="image/*" multiple onchange="handleMultipleImagesSelect(event)">
                            </div>
                            <div id="uploadStatus" class="upload-status"></div>
                            
                            <!-- Images preview container -->
                            <div id="imagesPreview" class="images-preview"></div>
                            
                            <!-- Hidden field to store image URLs as JSON -->
                            <input type="hidden" id="productImageUrls">
                        </div>
                        
                        <button onclick="addProduct()">Ajouter Produit</button>
                        <button id="cancelEditBtn" class="secondary-btn hidden" onclick="cancelEdit()" style="margin-left: 10px;">
                            <i class="fas fa-times"></i> Annuler
                        </button>
                    </div>

                    <div class="section">
                        <h2>Produits existants</h2>
                        <div class="search-box">
                            <input type="text" id="productSearch" placeholder="Rechercher un produit..." oninput="searchProducts()">
                        </div>
                        <div id="productsList"></div>
                    </div>
                </div>
                
                <!-- Orders Tab -->
                <!-- Replace the entire Orders Tab content with this: -->
                <div id="orders" class="tab-content">
                    <h1>Gestion des commandes</h1>
    
    <!-- Export Section -->
               <!-- Replace the export-section div with this: -->
               <!-- Update the export section text in your HTML -->
                <div class="export-section">
                    <h3>Export des commandes vers Google Sheets</h3>
                    <p style="color: #666; font-size: 14px;">
                        <i class="fas fa-info-circle" style="color: #34A853;"></i>
                        Export sans images de produits - uniquement les informations textuelles
                    </p>
                    <div class="export-options">
                        <button onclick="exportOrdersToGoogleSheets()" class="download-btn">
                            <i class="fas fa-file-export"></i> Exporter vers CSV (sans images)
                        </button>
                    </div>
                    <div id="googleSheetsStatus" class="googleSheetsStatus" style="display:none;"></div>
                </div>
                
                <div class="filter-options">
                    <button class="filter-btn active" onclick="filterOrders('all')">Toutes</button>
                    <button class="filter-btn" onclick="filterOrders('pending')">En attente</button>
                    <button class="filter-btn" onclick="filterOrders('confirmed')">Confirmées</button>
                    <button class="filter-btn" onclick="filterOrders('shipped')">Expédiées</button>
                    <button class="filter-btn" onclick="filterOrders('delivered')">Livrées</button>
                    <button class="filter-btn" onclick="filterOrders('cancelled')">Annulées</button>
                </div>
                
                    <div class="section">
                        <div id="ordersList"></div>
                    </div>
                </div>

                <!-- Contact Messages Tab -->
                <div id="contactMessages" class="tab-content">
                    <h1>Messages de Contact</h1>
                    
                    <div class="filter-options">
                        <button class="filter-btn active" onclick="filterMessages('all')">Tous</button>
                        <button class="filter-btn" onclick="filterMessages('new')">Nouveaux</button>
                        <button class="filter-btn" onclick="filterMessages('read')">Lus</button>
                        <button class="filter-btn" onclick="filterMessages('replied')">Répondu</button>
                    </div>
                    
                    <!-- Debug Section -->
                    <div class="section" style="margin-top: 20px;">
                        <h3>Débogage Messages</h3>
                        <button onclick="debugMessages()" class="secondary-btn">
                            <i class="fas fa-bug"></i> Vérifier les données des messages
                        </button>
                        <div id="debugMessages" style="margin-top: 10px; padding: 10px; background: #f5f5f5; border-radius: 4px; display: none;"></div>
                    </div>
                    
                    <div class="section">
                        <div id="contactMessagesList"></div>
                    </div>
                </div>
                
                <!-- Profile Tab -->
                <div id="profile" class="tab-content">
                    <h1>Gestion du profil</h1>
                    <div class="section">
                        <h2>Changer le mot de passe</h2>
                        <div class="form-group">
                            <label for="currentPassword">Mot de passe actuel:</label>
                            <input type="password" id="currentPassword">
                        </div>
                        <div class="form-group">
                            <label for="newPassword">Nouveau mot de passe:</label>
                            <input type="password" id="newPassword">
                        </div>
                        <div class="form-group">
                            <label for="confirmNewPassword">Confirmer le nouveau mot de passe:</label>
                            <input type="password" id="confirmNewPassword">
                        </div>
                        <button onclick="changePassword()">Changer le mot de passe</button>
                    </div>
                </div>
            </div>

            <div class="section">
                <h2>Journal d'activité</h2>
                <pre id="debug"></pre>
            </div>
        </div>
    </div>

 <script>
const firebaseConfig = {
    apiKey: "AIzaSyDxHAlR86M1U_-sBdLtZ6nEh0ssUREQY5M",
    authDomain: "muskandamber-83cd8.firebaseapp.com",
    projectId: "muskandamber-83cd8",
    storageBucket: "muskandamber-83cd8.firebasestorage.app",
    messagingSenderId: "820622006518",
    appId: "1:820622006518:web:540280c4c18f2e94ac74d7",
    measurementId: "G-58WS7ZEYG3"
};

// Initialize Firebase
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();
const auth = firebase.auth();

let currentUser = null;
let editingProductId = null;

// DOM Elements
const authSection = document.getElementById('authSection');
const adminPanel = document.getElementById('adminPanel');
const userEmail = document.getElementById('userEmail');
const emailInput = document.getElementById('email');
const passwordInput = document.getElementById('password');
const authMessage = document.getElementById('authMessage');
const registerForm = document.getElementById('registerForm');
const regEmail = document.getElementById('regEmail');
const regPassword = document.getElementById('regPassword');
const regConfirmPassword = document.getElementById('regConfirmPassword');

// Tab elements
const tabButtons = document.querySelectorAll('.tab-button');
const tabContents = document.querySelectorAll('.tab-content');

// Product form elements
const productBrand = document.getElementById('productBrand');
const productName = document.getElementById('productName');
const productPrice = document.getElementById('productPrice');
const productDescription = document.getElementById('productDescription');
const productImageUrls = document.getElementById('productImageUrls');
const multipleImageInput = document.getElementById('multipleImageInput');
const imagesPreview = document.getElementById('imagesPreview');
const uploadStatus = document.getElementById('uploadStatus');
const cancelEditBtn = document.getElementById('cancelEditBtn');

// Stats elements
const productsCount = document.getElementById('productsCount');
const ordersCount = document.getElementById('ordersCount');
const revenueCount = document.getElementById('revenueCount');
const messagesCount = document.getElementById('messagesCount');
const recentOrders = document.getElementById('recentOrders');
const recentMessages = document.getElementById('recentMessages');
const productsList = document.getElementById('productsList');
const productSearch = document.getElementById('productSearch');
const ordersList = document.getElementById('ordersList');
const contactMessagesList = document.getElementById('contactMessagesList');

// Check auth state on page load
auth.onAuthStateChanged((user) => {
    if (user) {
        currentUser = user;
        userEmail.textContent = user.email;
        authSection.classList.add('hidden');
        adminPanel.classList.remove('hidden');
        loadDashboardData();
        loadProducts();
        loadOrders();
        loadContactMessages();
    } else {
        currentUser = null;
        authSection.classList.remove('hidden');
        adminPanel.classList.add('hidden');
    }
});

// ========== AUTH FUNCTIONS ==========
function login() {
    const email = emailInput.value;
    const password = passwordInput.value;
    
    if (!email || !password) {
        showAuthMessage('Veuillez remplir tous les champs', 'error');
        return;
    }
    
    auth.signInWithEmailAndPassword(email, password)
        .then(() => {
            showAuthMessage('Connexion réussie!', 'success');
        })
        .catch((error) => {
            console.error('Login error:', error);
            showAuthMessage('Erreur de connexion: ' + error.message, 'error');
        });
}

function showRegister() {
    document.querySelector('.auth-form').classList.add('hidden');
    registerForm.classList.remove('hidden');
}

function showLogin() {
    registerForm.classList.add('hidden');
    document.querySelector('.auth-form').classList.remove('hidden');
}

function register() {
    const email = regEmail.value;
    const password = regPassword.value;
    const confirmPassword = regConfirmPassword.value;
    
    if (!email || !password || !confirmPassword) {
        showAuthMessage('Veuillez remplir tous les champs', 'error');
        return;
    }
    
    if (password !== confirmPassword) {
        showAuthMessage('Les mots de passe ne correspondent pas', 'error');
        return;
    }
    
    if (password.length < 6) {
        showAuthMessage('Le mot de passe doit contenir au moins 6 caractères', 'error');
        return;
    }
    
    auth.createUserWithEmailAndPassword(email, password)
        .then(() => {
            showAuthMessage('Compte créé avec succès!', 'success');
            showLogin();
        })
        .catch((error) => {
            console.error('Register error:', error);
            showAuthMessage('Erreur d\'inscription: ' + error.message, 'error');
        });
}

function showAuthMessage(message, type = 'info') {
    authMessage.textContent = message;
    authMessage.className = `alert alert-${type}`;
    authMessage.classList.remove('hidden');
    
    setTimeout(() => {
        authMessage.classList.add('hidden');
    }, 3000);
}

function logout() {
    if (confirm('Êtes-vous sûr de vouloir vous déconnecter?')) {
        auth.signOut();
    }
}

function changePassword() {
    const currentPassword = document.getElementById('currentPassword').value;
    const newPassword = document.getElementById('newPassword').value;
    const confirmNewPassword = document.getElementById('confirmNewPassword').value;
    
    if (!currentPassword || !newPassword || !confirmNewPassword) {
        showNotification('Veuillez remplir tous les champs', 'error');
        return;
    }
    
    if (newPassword !== confirmNewPassword) {
        showNotification('Les nouveaux mots de passe ne correspondent pas', 'error');
        return;
    }
    
    if (newPassword.length < 6) {
        showNotification('Le nouveau mot de passe doit contenir au moins 6 caractères', 'error');
        return;
    }
    
    const user = auth.currentUser;
    const credential = firebase.auth.EmailAuthProvider.credential(user.email, currentPassword);
    
    user.reauthenticateWithCredential(credential)
        .then(() => {
            return user.updatePassword(newPassword);
        })
        .then(() => {
            showNotification('Mot de passe changé avec succès!', 'success');
            document.getElementById('currentPassword').value = '';
            document.getElementById('newPassword').value = '';
            document.getElementById('confirmNewPassword').value = '';
        })
        .catch((error) => {
            console.error('Password change error:', error);
            showNotification('Erreur: ' + error.message, 'error');
        });
}

// ========== TAB FUNCTIONS ==========
function openTab(tabName) {
    // Update tab buttons
    tabButtons.forEach(button => {
        if (button.getAttribute('onclick').includes(tabName)) {
            button.classList.add('active');
        } else {
            button.classList.remove('active');
        }
    });
    
    // Update tab contents
    tabContents.forEach(content => {
        if (content.id === tabName) {
            content.classList.add('active');
        } else {
            content.classList.remove('active');
        }
    });
}

// ========== DASHBOARD FUNCTIONS ==========
async function loadDashboardData() {
    try {
        // Load products count
        const productsSnapshot = await db.collection('products').get();
        productsCount.textContent = productsSnapshot.size;
        
        // Load orders count and revenue
        const ordersSnapshot = await db.collection('orders').get();
        ordersCount.textContent = ordersSnapshot.size;
        
        let totalRevenue = 0;
        ordersSnapshot.forEach(doc => {
            const order = doc.data();
            totalRevenue += order.total || 0;
        });
        revenueCount.textContent = totalRevenue.toFixed(2);
        
        // Load messages count
        const messagesSnapshot = await db.collection('contactMessages').get();
        messagesCount.textContent = messagesSnapshot.size;
        
        // Load recent orders
        loadRecentOrders();
        
        // Load recent messages
        loadRecentMessages();
        
    } catch (error) {
        console.error('Error loading dashboard data:', error);
    }
}

async function loadRecentOrders() {
    try {
        const snapshot = await db.collection('orders')
            .orderBy('timestamp', 'desc')
            .limit(5)
            .get();
        
        if (snapshot.empty) {
            recentOrders.innerHTML = '<p>Aucune commande récente</p>';
            return;
        }
        
        let html = '<div class="data-table">';
        html += '<table><thead><tr><th>N° Commande</th><th>Client</th><th>Total</th><th>Statut</th><th>Date</th></tr></thead><tbody>';
        
        snapshot.forEach(doc => {
            const order = doc.data();
            const date = order.timestamp ? order.timestamp.toDate().toLocaleDateString() : 'N/A';
            
            html += `
                <tr>
                    <td>${order.orderNumber || 'N/A'}</td>
                    <td>${order.customer?.name || 'N/A'}</td>
                    <td>${order.total?.toFixed(2) || '0.00'} MAD</td>
                    <td>
                        <select class="status-select" data-id="${doc.id}" onchange="updateOrderStatus('${doc.id}', this.value)">
                            <option value="pending" ${order.status === 'pending' ? 'selected' : ''}>En attente</option>
                            <option value="confirmed" ${order.status === 'confirmed' ? 'selected' : ''}>Confirmée</option>
                            <option value="shipped" ${order.status === 'shipped' ? 'selected' : ''}>Expédiée</option>
                            <option value="delivered" ${order.status === 'delivered' ? 'selected' : ''}>Livrée</option>
                            <option value="cancelled" ${order.status === 'cancelled' ? 'selected' : ''}>Annulée</option>
                        </select>
                    </td>
                    <td>${date}</td>
                </tr>
            `;
        });
        
        html += '</tbody></table></div>';
        recentOrders.innerHTML = html;
        
    } catch (error) {
        console.error('Error loading recent orders:', error);
        recentOrders.innerHTML = '<p class="alert-error">Erreur de chargement des commandes</p>';
    }
}

async function loadRecentMessages() {
    try {
        const snapshot = await db.collection('contactMessages')
            .orderBy('timestamp', 'desc')
            .limit(5)
            .get();
        
        if (snapshot.empty) {
            recentMessages.innerHTML = '<p>Aucun message récent</p>';
            return;
        }
        
        let html = '';
        snapshot.forEach(doc => {
            const message = doc.data();
            const date = message.timestamp ? message.timestamp.toDate().toLocaleDateString() : 'N/A';
            
            html += `
                <div class="message-container">
                    <div class="message-header">
                        <div>
                            <div class="message-sender">${message.name}</div>
                            <div class="message-email">${message.email}</div>
                        </div>
                        <div class="message-date">${date}</div>
                    </div>
                    <div class="message-content">${message.message}</div>
                    <div class="message-actions">
                        <span class="message-status ${message.status === 'read' ? 'status-read' : 'status-pending'}">
                            ${message.status === 'read' ? 'Lu' : 'Non lu'}
                        </span>
                        <button class="secondary-btn" onclick="markMessageAsRead('${doc.id}')">
                            <i class="fas fa-check"></i> Marquer comme lu
                        </button>
                        <button class="delete-btn" onclick="deleteMessage('${doc.id}')">
                            <i class="fas fa-trash"></i> Supprimer
                        </button>
                    </div>
                </div>
            `;
        });
        
        recentMessages.innerHTML = html;
        
    } catch (error) {
        console.error('Error loading recent messages:', error);
        recentMessages.innerHTML = '<p class="alert-error">Erreur de chargement des messages</p>';
    }
}

// ========== PRODUCT FUNCTIONS ==========
function handleMultipleImagesSelect(event) {
    const files = event.target.files;
    if (!files || files.length === 0) return;
    
    // Clear previous previews
    imagesPreview.innerHTML = '';
    
    // Limit to 5 images
    const fileCount = Math.min(files.length, 5);
    
    for (let i = 0; i < fileCount; i++) {
        const file = files[i];
        const reader = new FileReader();
        
        reader.onload = function(e) {
            const imgElement = document.createElement('div');
            imgElement.className = 'image-preview-item';
            imgElement.innerHTML = `
                <img src="${e.target.result}" alt="Preview">
                <button class="remove-image-btn" onclick="removeImagePreview(this)">&times;</button>
            `;
            imagesPreview.appendChild(imgElement);
        };
        
        reader.readAsDataURL(file);
    }
    
    // Store files for upload
    multipleImageInput.dataset.files = JSON.stringify(Array.from(files).slice(0, 5));
}

function removeImagePreview(button) {
    const previewItem = button.parentElement;
    previewItem.remove();
}

async function uploadImages(files) {
    const imageUrls = [];
    
    for (const file of files) {
        // In a real app, you would upload to Firebase Storage
        // For now, we'll simulate by creating a data URL
        const reader = new FileReader();
        
        const promise = new Promise((resolve) => {
            reader.onload = function(e) {
                // In production: Upload to Firebase Storage and get URL
                // For demo, use the data URL
                resolve(e.target.result);
            };
            reader.readAsDataURL(file);
        });
        
        const imageUrl = await promise;
        imageUrls.push(imageUrl);
    }
    
    return imageUrls;
}

async function addProduct() {
    // Collect form data
    const brand = productBrand.value.trim();
    const name = productName.value.trim();
    const price = parseFloat(productPrice.value);
    const description = productDescription.value.trim();
    
    // Collect categories
    const categories = [];
    document.querySelectorAll('.checkbox-group input[type="checkbox"]:checked').forEach(checkbox => {
        categories.push(checkbox.value);
    });
    
    // Collect volume
    const volume = document.querySelector('input[name="volume"]:checked')?.value || '50';
    
    // Collect stock statuses
    const stockStatuses = [];
    document.querySelectorAll('input[name="stockStatus"]:checked').forEach(checkbox => {
        stockStatuses.push(checkbox.value);
    });
    
    // Validate required fields
    if (!name || !price || categories.length === 0 || !volume || stockStatuses.length === 0) {
        showNotification('Veuillez remplir tous les champs obligatoires', 'error');
        return;
    }
    
    // Upload images
    const files = JSON.parse(multipleImageInput.dataset.files || '[]');
    let imageUrls = [];
    
    if (files.length > 0) {
        try {
            uploadStatus.textContent = 'Téléchargement des images...';
            uploadStatus.className = 'upload-status upload-progress';
            uploadStatus.style.display = 'block';
            
            imageUrls = await uploadImages(files);
            
            uploadStatus.textContent = 'Images téléchargées avec succès!';
            uploadStatus.className = 'upload-status upload-success';
            
        } catch (error) {
            console.error('Image upload error:', error);
            uploadStatus.textContent = 'Erreur lors du téléchargement des images';
            uploadStatus.className = 'upload-status upload-error';
            return;
        }
    }
    
    // Prepare product data
    const productData = {
        brand,
        name,
        price,
        description,
        categories,
        volume: volume + 'ml',
        stockStatuses,
        imageUrls,
        createdAt: firebase.firestore.FieldValue.serverTimestamp()
    };
    
    try {
        if (editingProductId) {
            // Update existing product
            await db.collection('products').doc(editingProductId).update(productData);
            showNotification('Produit mis à jour avec succès!', 'success');
            cancelEdit();
        } else {
            // Add new product
            await db.collection('products').add(productData);
            showNotification('Produit ajouté avec succès!', 'success');
        }
        
        // Reset form
        resetProductForm();
        loadProducts();
        
    } catch (error) {
        console.error('Error saving product:', error);
        showNotification('Erreur lors de l\'enregistrement: ' + error.message, 'error');
    }
}

function resetProductForm() {
    productBrand.value = '';
    productName.value = '';
    productPrice.value = '';
    productDescription.value = '';
    
    // Clear checkboxes
    document.querySelectorAll('.checkbox-group input[type="checkbox"]').forEach(checkbox => {
        checkbox.checked = false;
    });
    
    // Clear radio buttons
    document.querySelectorAll('input[name="volume"]').forEach(radio => {
        radio.checked = false;
    });
    
    // Set default volume to 50ml
    document.getElementById('vol-50').checked = true;
    
    // Clear stock status checkboxes
    document.querySelectorAll('input[name="stockStatus"]').forEach(checkbox => {
        checkbox.checked = false;
    });
    
    // Check "en stock" by default
    document.getElementById('stock-in').checked = true;
    
    // Clear image previews
    imagesPreview.innerHTML = '';
    multipleImageInput.value = '';
    multipleImageInput.dataset.files = '[]';
    uploadStatus.style.display = 'none';
}

async function loadProducts() {
    try {
        const snapshot = await db.collection('products').orderBy('createdAt', 'desc').get();
        
        if (snapshot.empty) {
            productsList.innerHTML = '<p>Aucun produit trouvé</p>';
            return;
        }
        
        let html = '<div class="data-table">';
        html += '<table><thead><tr><th>Image</th><th>Marque</th><th>Nom</th><th>Prix</th><th>Catégories</th><th>Statut</th><th>Actions</th></tr></thead><tbody>';
        
        snapshot.forEach(doc => {
            const product = doc.data();
            const mainImage = product.imageUrls && product.imageUrls.length > 0 
                ? product.imageUrls[0] 
                : 'https://via.placeholder.com/100';
            
            const categories = product.categories ? product.categories.join(', ') : '';
            const stockStatus = product.stockStatuses ? product.stockStatuses.join(', ') : 'en stock';
            
            html += `
                <tr>
                    <td><img src="${mainImage}" alt="${product.name}" class="product-image-admin" style="width: 100px; height: 100px; object-fit: cover;"></td>
                    <td>${product.brand || '-'}</td>
                    <td>${product.name}</td>
                    <td>${product.price?.toFixed(2) || '0.00'} MAD</td>
                    <td>${categories}</td>
                    <td>${stockStatus}</td>
                    <td>
                        <button class="edit-btn" onclick="editProduct('${doc.id}')">
                            <i class="fas fa-edit"></i> Modifier
                        </button>
                        <button class="delete-btn" onclick="deleteProduct('${doc.id}')">
                            <i class="fas fa-trash"></i> Supprimer
                        </button>
                    </td>
                </tr>
            `;
        });
        
        html += '</tbody></table></div>';
        productsList.innerHTML = html;
        
    } catch (error) {
        console.error('Error loading products:', error);
        productsList.innerHTML = '<p class="alert-error">Erreur de chargement des produits</p>';
    }
}

async function editProduct(productId) {
    try {
        const doc = await db.collection('products').doc(productId).get();
        
        if (doc.exists) {
            const product = doc.data();
            editingProductId = productId;
            
            // Fill form with product data
            productBrand.value = product.brand || '';
            productName.value = product.name || '';
            productPrice.value = product.price || '';
            productDescription.value = product.description || '';
            
            // Set categories
            document.querySelectorAll('.checkbox-group input[type="checkbox"]').forEach(checkbox => {
                checkbox.checked = product.categories?.includes(checkbox.value) || false;
            });
            
            // Set volume
            const volumeValue = product.volume ? product.volume.replace('ml', '') : '50';
            document.querySelector(`input[name="volume"][value="${volumeValue}"]`).checked = true;
            
            // Set stock statuses
            document.querySelectorAll('input[name="stockStatus"]').forEach(checkbox => {
                checkbox.checked = product.stockStatuses?.includes(checkbox.value) || false;
            });
            
            // Show existing images
            imagesPreview.innerHTML = '';
            if (product.imageUrls && product.imageUrls.length > 0) {
                product.imageUrls.forEach((imageUrl, index) => {
                    const imgElement = document.createElement('div');
                    imgElement.className = 'image-preview-item';
                    imgElement.innerHTML = `
                        <img src="${imageUrl}" alt="Preview">
                        <button class="remove-image-btn" onclick="removeImagePreview(this)">&times;</button>
                    `;
                    imagesPreview.appendChild(imgElement);
                });
            }
            
            // Store existing image URLs
            productImageUrls.value = JSON.stringify(product.imageUrls || []);
            
            // Show cancel button
            cancelEditBtn.classList.remove('hidden');
            
            // Change add button text
            document.querySelector('button[onclick="addProduct()"]').textContent = 'Mettre à jour';
            
            // Scroll to form
            document.querySelector('#products .section:first-child').scrollIntoView({ behavior: 'smooth' });
            
            showNotification('Modifiez le produit et cliquez sur "Mettre à jour"', 'info');
        }
        
    } catch (error) {
        console.error('Error loading product for edit:', error);
        showNotification('Erreur de chargement du produit', 'error');
    }
}

function cancelEdit() {
    editingProductId = null;
    resetProductForm();
    cancelEditBtn.classList.add('hidden');
    document.querySelector('button[onclick="addProduct()"]').textContent = 'Ajouter Produit';
    showNotification('Édition annulée', 'info');
}

async function deleteProduct(productId) {
    if (!confirm('Êtes-vous sûr de vouloir supprimer ce produit?')) {
        return;
    }
    
    try {
        await db.collection('products').doc(productId).delete();
        showNotification('Produit supprimé avec succès!', 'success');
        loadProducts();
        loadDashboardData();
    } catch (error) {
        console.error('Error deleting product:', error);
        showNotification('Erreur lors de la suppression: ' + error.message, 'error');
    }
}

function searchProducts() {
    const searchTerm = productSearch.value.toLowerCase().trim();
    const rows = productsList.querySelectorAll('tbody tr');
    
    rows.forEach(row => {
        const text = row.textContent.toLowerCase();
        row.style.display = text.includes(searchTerm) ? '' : 'none';
    });
}

// ========== ORDER FUNCTIONS ==========
async function loadOrders(filter = 'all') {
    try {
        let query = db.collection('orders').orderBy('timestamp', 'desc');
        
        // Apply filter if not 'all'
        if (filter !== 'all') {
            query = query.where('status', '==', filter);
        }
        
        const snapshot = await query.get();
        
        if (snapshot.empty) {
            ordersList.innerHTML = '<p>Aucune commande trouvée</p>';
            return;
        }
        
        let html = '';
        snapshot.forEach(doc => {
            const order = doc.data();
            const date = order.timestamp ? order.timestamp.toDate().toLocaleDateString() : 'N/A';
            const time = order.timestamp ? order.timestamp.toDate().toLocaleTimeString() : '';
            
            html += `
                <div class="order-details">
                    <div class="order-header">
                        <div>
                            <div class="order-id">Commande #${order.orderNumber || doc.id.substring(0, 8)}</div>
                            <div style="font-size: 14px; color: #666;">${date} à ${time}</div>
                        </div>
                        <div class="order-total">${order.total?.toFixed(2) || '0.00'} MAD</div>
                    </div>
                    
                    <div class="order-items">
                        <h4>Articles:</h4>
                        ${order.items ? order.items.map(item => `
                            <div class="order-item">
                                <div class="item-name">${item.name} (${item.size || item.volume || '50ml'})</div>
                                <div class="item-size">${item.quantity}x</div>
                                <div class="item-price">${(item.price * item.quantity).toFixed(2)} MAD</div>
                            </div>
                        `).join('') : '<p>Aucun article</p>'}
                    </div>
                    
                    <div class="order-customer">
                        <h4>Informations client:</h4>
                        <p><strong>Nom:</strong> ${order.customer?.name || 'N/A'}</p>
                        <p><strong>Téléphone:</strong> ${order.customer?.phone || 'N/A'}</p>
                        <p><strong>Adresse:</strong> ${order.customer?.address || 'N/A'}</p>
                        ${order.customer?.notes ? `<p><strong>Notes:</strong> ${order.customer.notes}</p>` : ''}
                    </div>
                    
                    <div class="message-actions" style="margin-top: 15px;">
                        <select class="status-select" data-id="${doc.id}" onchange="updateOrderStatus('${doc.id}', this.value)">
                            <option value="pending" ${order.status === 'pending' ? 'selected' : ''}>En attente</option>
                            <option value="confirmed" ${order.status === 'confirmed' ? 'selected' : ''}>Confirmée</option>
                            <option value="shipped" ${order.status === 'shipped' ? 'selected' : ''}>Expédiée</option>
                            <option value="delivered" ${order.status === 'delivered' ? 'selected' : ''}>Livrée</option>
                            <option value="cancelled" ${order.status === 'cancelled' ? 'selected' : ''}>Annulée</option>
                        </select>
                        <button class="secondary-btn" onclick="viewOrderDetails('${doc.id}')">
                            <i class="fas fa-eye"></i> Détails
                        </button>
                        <button class="delete-btn" onclick="deleteOrder('${doc.id}')">
                            <i class="fas fa-trash"></i> Supprimer
                        </button>
                    </div>
                </div>
            `;
        });
        
        ordersList.innerHTML = html;
        
    } catch (error) {
        console.error('Error loading orders:', error);
        ordersList.innerHTML = '<p class="alert-error">Erreur de chargement des commandes</p>';
    }
}

function filterOrders(filter) {
    // Update filter buttons
    document.querySelectorAll('.filter-btn').forEach(btn => {
        if (btn.textContent.toLowerCase().includes(filter)) {
            btn.classList.add('active');
        } else {
            btn.classList.remove('active');
        }
    });
    
    // Load orders with filter
    loadOrders(filter);
}

async function updateOrderStatus(orderId, status) {
    try {
        await db.collection('orders').doc(orderId).update({
            status: status,
            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        
        showNotification(`Statut de la commande mis à jour: ${status}`, 'success');
        loadRecentOrders();
        
    } catch (error) {
        console.error('Error updating order status:', error);
        showNotification('Erreur de mise à jour: ' + error.message, 'error');
    }
}

async function deleteOrder(orderId) {
    if (!confirm('Êtes-vous sûr de vouloir supprimer cette commande?')) {
        return;
    }
    
    try {
        await db.collection('orders').doc(orderId).delete();
        showNotification('Commande supprimée avec succès!', 'success');
        loadOrders();
        loadDashboardData();
    } catch (error) {
        console.error('Error deleting order:', error);
        showNotification('Erreur lors de la suppression: ' + error.message, 'error');
    }
}

function viewOrderDetails(orderId) {
    // In a real app, you might open a modal or new page with full details
    alert('Fonctionnalité de détails à implémenter pour la commande: ' + orderId);
}

// ========== CONTACT MESSAGE FUNCTIONS ==========
async function loadContactMessages(filter = 'all') {
    try {
        let query = db.collection('contactMessages').orderBy('timestamp', 'desc');
        
        // Apply filter
        if (filter === 'new') {
            query = query.where('status', '==', 'new');
        } else if (filter === 'read') {
            query = query.where('status', '==', 'read');
        } else if (filter === 'replied') {
            query = query.where('status', '==', 'replied');
        }
        
        const snapshot = await query.get();
        
        if (snapshot.empty) {
            contactMessagesList.innerHTML = '<p>Aucun message trouvé</p>';
            return;
        }
        
        let html = '';
        snapshot.forEach(doc => {
            const message = doc.data();
            const date = message.timestamp ? message.timestamp.toDate().toLocaleDateString() : 'N/A';
            const time = message.timestamp ? message.timestamp.toDate().toLocaleTimeString() : '';
            
            html += `
                <div class="message-container">
                    <div class="message-header">
                        <div>
                            <div class="message-sender">${message.name}</div>
                            <div class="message-email">${message.email}</div>
                        </div>
                        <div>
                            <div class="message-date">${date} à ${time}</div>
                            <span class="message-status ${message.status === 'read' ? 'status-read' : 'status-pending'}">
                                ${getStatusDisplay(message.status)}
                            </span>
                        </div>
                    </div>
                    <div class="message-content">${message.message}</div>
                    <div class="message-actions">
                        <button class="secondary-btn" onclick="markMessageAsRead('${doc.id}')">
                            <i class="fas fa-check"></i> Marquer comme lu
                        </button>
                        <button class="secondary-btn" onclick="replyToMessage('${message.email}')">
                            <i class="fas fa-reply"></i> Répondre
                        </button>
                        <button class="delete-btn" onclick="deleteMessage('${doc.id}')">
                            <i class="fas fa-trash"></i> Supprimer
                        </button>
                    </div>
                </div>
            `;
        });
        
        contactMessagesList.innerHTML = html;
        
    } catch (error) {
        console.error('Error loading contact messages:', error);
        contactMessagesList.innerHTML = '<p class="alert-error">Erreur de chargement des messages</p>';
    }
}

function getStatusDisplay(status) {
    switch(status) {
        case 'new': return 'Non lu';
        case 'read': return 'Lu';
        case 'replied': return 'Répondu';
        default: return status;
    }
}

function filterMessages(filter) {
    // Update filter buttons
    document.querySelectorAll('#contactMessages .filter-btn').forEach(btn => {
        btn.classList.remove('active');
    });
    event.target.classList.add('active');
    
    // Load messages with filter
    loadContactMessages(filter);
}

async function markMessageAsRead(messageId) {
    try {
        await db.collection('contactMessages').doc(messageId).update({
            status: 'read',
            readAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        
        showNotification('Message marqué comme lu', 'success');
        loadContactMessages();
        loadRecentMessages();
        
    } catch (error) {
        console.error('Error marking message as read:', error);
        showNotification('Erreur: ' + error.message, 'error');
    }
}

function replyToMessage(email) {
    window.location.href = `mailto:${email}`;
}

async function deleteMessage(messageId) {
    if (!confirm('Êtes-vous sûr de vouloir supprimer ce message?')) {
        return;
    }
    
    try {
        await db.collection('contactMessages').doc(messageId).delete();
        showNotification('Message supprimé avec succès!', 'success');
        loadContactMessages();
        loadDashboardData();
    } catch (error) {
        console.error('Error deleting message:', error);
        showNotification('Erreur lors de la suppression: ' + error.message, 'error');
    }
}

function debugMessages() {
    const debugDiv = document.getElementById('debugMessages');
    debugDiv.style.display = debugDiv.style.display === 'none' ? 'block' : 'none';
    
    // Add your debug logic here
    debugDiv.innerHTML = '<p>Fonction de débogage à implémenter</p>';
}

// ========== EXPORT FUNCTIONS ==========
async function exportOrdersToGoogleSheets() {
    try {
        const snapshot = await db.collection('orders').get();
        
        if (snapshot.empty) {
            showNotification('Aucune commande à exporter', 'warning');
            return;
        }
        
        let csvContent = "data:text/csv;charset=utf-8,";
        
        // Add header row
        csvContent += "Order ID,Date,Client Name,Phone,Address,Total,Status\n";
        
        // Add data rows
        snapshot.forEach(doc => {
            const order = doc.data();
            const date = order.timestamp ? order.timestamp.toDate().toLocaleDateString() : 'N/A';
            
            csvContent += `"${order.orderNumber || doc.id}","${date}","${order.customer?.name || ''}","${order.customer?.phone || ''}","${order.customer?.address || ''}",${order.total || 0},"${order.status || 'pending'}"\n`;
        });
        
        // Create download link
        const encodedUri = encodeURI(csvContent);
        const link = document.createElement("a");
        link.setAttribute("href", encodedUri);
        link.setAttribute("download", `commandes_${new Date().toISOString().split('T')[0]}.csv`);
        document.body.appendChild(link);
        
        // Trigger download
        link.click();
        document.body.removeChild(link);
        
        showNotification(`${snapshot.size} commandes exportées avec succès!`, 'success');
        
    } catch (error) {
        console.error('Error exporting orders:', error);
        showNotification('Erreur lors de l\'export: ' + error.message, 'error');
    }
}

// ========== UTILITY FUNCTIONS ==========
function showNotification(message, type = 'success') {
    // Remove existing notification
    const existingNotification = document.querySelector('.notification');
    if (existingNotification) {
        existingNotification.remove();
    }
    
    // Create notification element
    const notification = document.createElement('div');
    notification.className = `notification notification-${type}`;
    notification.innerHTML = `
        <div class="notification-content">
            <i class="fas fa-${type === 'success' ? 'check-circle' : 'exclamation-circle'}"></i>
            <span>${message}</span>
        </div>
    `;
    
    document.body.appendChild(notification);
    
    // Remove after 3 seconds
    setTimeout(() => {
        notification.style.animation = 'slideOut 0.3s ease';
        setTimeout(() => notification.remove(), 300);
    }, 3000);
}

// Initialize on load
document.addEventListener('DOMContentLoaded', function() {
    // Set default volume selection
    document.getElementById('vol-50').checked = true;
    
    // Set default stock status
    document.getElementById('stock-in').checked = true;
});
</script>
</body>
</html>
